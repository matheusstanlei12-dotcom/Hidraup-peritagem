import React, { Suspense } from 'react';
import { BrowserRouter as Router, Routes, Route, Navigate } from 'react-router-dom';
import { Capacitor } from '@capacitor/core';
import { Layout } from './components/Layout';
import { AuthProvider, useAuth } from './contexts/AuthContext';
import './index.css';

// Lazy Load Pages
const LoginPage = React.lazy(() => import('./pages/Login').then(module => ({ default: module.LoginPage })));
const RegisterPage = React.lazy(() => import('./pages/Register').then(module => ({ default: module.RegisterPage })));
const Dashboard = React.lazy(() => import('./pages/Dashboard').then(module => ({ default: module.Dashboard })));
const Peritagens = React.lazy(() => import('./pages/Peritagens').then(module => ({ default: module.Peritagens })));
const Monitoramento = React.lazy(() => import('./pages/Monitoramento').then(module => ({ default: module.Monitoramento })));
const Relatorios = React.lazy(() => import('./pages/Relatorios').then(module => ({ default: module.Relatorios })));
const NovaPeritagem = React.lazy(() => import('./pages/NovaPeritagem').then(module => ({ default: module.NovaPeritagem })));
const Clientes = React.lazy(() => import('./pages/Clientes').then(module => ({ default: module.Clientes })));
const Manutencao = React.lazy(() => import('./pages/Manutencao').then(module => ({ default: module.Manutencao })));
const PcpAprovaPeritagem = React.lazy(() => import('./pages/PcpAprovaPeritagem').then(module => ({ default: module.PcpAprovaPeritagem })));
const PcpLiberaPedido = React.lazy(() => import('./pages/PcpLiberaPedido').then(module => ({ default: module.PcpLiberaPedido })));
const PcpFinalizaProcesso = React.lazy(() => import('./pages/PcpFinalizaProcesso').then(module => ({ default: module.PcpFinalizaProcesso })));
const RegistroFotos = React.lazy(() => import('./pages/RegistroFotos').then(module => ({ default: module.RegistroFotos })));
const AdminUsers = React.lazy(() => import('./pages/AdminUsers').then(module => ({ default: module.AdminUsers })));
const AdminEmpresas = React.lazy(() => import('./pages/AdminEmpresas').then(module => ({ default: module.AdminEmpresas })));
const QrCodePage = React.lazy(() => import('./pages/QrCodePage').then(module => ({ default: module.QrCodePage })));
const ClientPeritagens = React.lazy(() => import('./pages/ClientPeritagens').then(module => ({ default: module.ClientPeritagens })));
const DataBook = React.lazy(() => import('./pages/DataBook').then(module => ({ default: module.DataBook })));
const AguardandoPeritagem = React.lazy(() => import('./pages/AguardandoPeritagem').then(module => ({ default: module.AguardandoPeritagem })));
const PendingApproval = React.lazy(() => import('./pages/PendingApproval').then(module => ({ default: module.PendingApproval })));

const LoadingSpinner = () => (
  <div style={{ display: 'flex', justifyContent: 'center', alignItems: 'center', height: '100vh' }}>
    <div className="loader" style={{
      border: '4px solid #f3f3f3',
      borderTop: '4px solid #3498db',
      borderRadius: '50%',
      width: '40px',
      height: '40px',
      animation: 'spin 1s linear infinite'
    }} />
    <style>{`
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
    `}</style>
  </div>
);

const PrivateRoute = ({ children, allowedRoles }: { children: React.ReactNode, allowedRoles?: string[] }) => {
  const { session, role, status, loading } = useAuth();

  const isApp = Capacitor.getPlatform() !== 'web';

  const isRestricted = isApp;

  if (loading) return <div style={{ display: 'flex', justifyContent: 'center', marginTop: '50px' }}>Carregando...</div>;

  if (!session) return <Navigate to="/login" />;

  // Verificação de Status (Bloqueia acesso se não estiver APROVADO)
  if (status !== 'APROVADO') {
    return <Navigate to="/pending-approval" />;
  }

  // Se for restrito (App ou Perito), só pode acessar Nova Peritagem e Minhas Peritagens
  const currentPath = window.location.pathname;
  const isAllowedPath = currentPath === '/nova-peritagem' || currentPath === '/peritagens';

  if (isRestricted && !isAllowedPath) {
    return <Navigate to={role === 'cliente' ? "/meus-relatorios" : "/peritagens"} />;
  }

  if (allowedRoles && role && !allowedRoles.includes(role)) {
    return <Navigate to={role === 'cliente' ? "/meus-relatorios" : "/peritagens"} />;
  }

  return <>{children}</>;
};

function AppRoutes() {
  const { session, loading, role, status } = useAuth();

  if (loading) return null;

  const isApp = Capacitor.getPlatform() !== 'web';

  const isRestricted = isApp;

  let defaultPath = isRestricted ? "/peritagens" : "/dashboard";

  if (role === 'cliente') {
    defaultPath = "/meus-relatorios";
  }

  return (
    <Suspense fallback={<LoadingSpinner />}>
      <Routes>
        <Route path="/login" element={session ? <Navigate to={defaultPath} /> : <LoginPage />} />
        <Route path="/register" element={session ? <Navigate to={defaultPath} /> : <RegisterPage />} />
        <Route path="/pending-approval" element={session ? (status === 'APROVADO' ? <Navigate to={defaultPath} /> : <PendingApproval />) : <Navigate to="/login" />} />

        <Route path="/" element={<Navigate to={session ? defaultPath : "/login"} replace />} />

        {/* Rotas Protegidas */}
        <Route path="/dashboard" element={<PrivateRoute allowedRoles={['gestor', 'pcp', 'perito']}><Layout><Dashboard /></Layout></PrivateRoute>} />
        <Route path="/peritagens" element={<PrivateRoute allowedRoles={['gestor', 'pcp', 'perito']}><Layout><Peritagens /></Layout></PrivateRoute>} />
        <Route path="/monitoramento" element={<PrivateRoute allowedRoles={['gestor', 'pcp', 'perito']}><Layout><Monitoramento /></Layout></PrivateRoute>} />
        <Route path="/clientes" element={<PrivateRoute allowedRoles={['gestor', 'pcp']}><Layout><Clientes /></Layout></PrivateRoute>} />
        <Route path="/manutencao" element={<PrivateRoute allowedRoles={['gestor', 'pcp', 'perito']}><Layout><Manutencao /></Layout></PrivateRoute>} />
        <Route path="/relatorios" element={<PrivateRoute allowedRoles={['gestor', 'pcp', 'perito']}><Layout><Relatorios /></Layout></PrivateRoute>} />
        <Route path="/registro-fotos" element={<PrivateRoute allowedRoles={['gestor', 'pcp', 'perito']}><Layout><RegistroFotos /></Layout></PrivateRoute>} />
        <Route path="/nova-peritagem" element={<PrivateRoute allowedRoles={['gestor', 'pcp', 'perito']}><Layout><NovaPeritagem /></Layout></PrivateRoute>} />
        <Route path="/databook" element={<PrivateRoute allowedRoles={['gestor', 'pcp', 'perito', 'cliente']}><Layout><DataBook /></Layout></PrivateRoute>} />

        {/* Rota Exclusiva Cliente */}
        <Route path="/meus-relatorios" element={<PrivateRoute allowedRoles={['cliente']}><Layout><ClientPeritagens /></Layout></PrivateRoute>} />

        {/* Rotas de Fluxo PCP */}
        <Route path="/pcp/aguardando" element={<PrivateRoute allowedRoles={['pcp', 'gestor', 'perito']}><Layout><AguardandoPeritagem /></Layout></PrivateRoute>} />
        <Route path="/pcp/aprovar" element={<PrivateRoute allowedRoles={['pcp', 'gestor', 'perito']}><Layout><PcpAprovaPeritagem /></Layout></PrivateRoute>} />
        <Route path="/pcp/liberar" element={<PrivateRoute allowedRoles={['pcp', 'gestor', 'perito']}><Layout><PcpLiberaPedido /></Layout></PrivateRoute>} />
        <Route path="/pcp/finalizar" element={<PrivateRoute allowedRoles={['pcp', 'gestor', 'perito']}><Layout><PcpFinalizaProcesso /></Layout></PrivateRoute>} />
        <Route path="/qrcode" element={<PrivateRoute allowedRoles={['pcp', 'gestor', 'perito']}><Layout><QrCodePage /></Layout></PrivateRoute>} />

        {/* Rota Exclusiva Gestor */}
        <Route path="/admin/usuarios" element={
          <PrivateRoute allowedRoles={['gestor']}>
            <Layout><AdminUsers /></Layout>
          </PrivateRoute>
        } />
        <Route path="/admin/empresas" element={
          <PrivateRoute allowedRoles={['gestor']}>
            <Layout><AdminEmpresas /></Layout>
          </PrivateRoute>
        } />
      </Routes>
    </Suspense>
  );
}

function App() {
  return (
    <AuthProvider>
      <Router>
        <AppRoutes />
      </Router>
    </AuthProvider>
  );
}

export default App;
